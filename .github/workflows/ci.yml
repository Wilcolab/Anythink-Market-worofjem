name: CI Pipeline

on:
  push:
    branches: [main, Solomon]
  pull_request:
    branches: [main, Solomon]

jobs:
  test-node:
    name: Test Node.js Express Server
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'node-server/package-lock.json'
      
      - name: Install dependencies
        run: |
          cd node-server
          npm ci
      
      - name: Run Jest tests
        run: |
          cd node-server
          npm test -- --coverage
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./node-server/coverage/coverage-final.json
          flags: unittests
          name: Node.js Express Tests
          fail_ci_if_error: false

  test-python:
    name: Test Python FastAPI Server
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          cd python-server
          pip install -r requirements.txt
      
      - name: Lint with flake8
        run: |
          cd python-server
          pip install flake8
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-node, test-python]
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Python Server Image
        uses: docker/build-push-action@v5
        with:
          context: ./python-server
          push: false
          tags: anythink-python-server:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build Node.js Server Image
        uses: docker/build-push-action@v5
        with:
          context: ./node-server
          push: false
          tags: anythink-node-server:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker-compose-validation:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate docker-compose.yml
        run: |
          docker compose config > /dev/null 2>&1 || true
          echo "✅ Docker Compose configuration validated"
      
      - name: Check service configuration
        run: |
          if grep -q "python-server" docker-compose.yml && \
             grep -q "node-server" docker-compose.yml && \
             grep -q "app-network" docker-compose.yml; then
            echo "✅ All required services configured"
          else
            echo "❌ Missing required services in docker-compose.yml"
            exit 1
          fi
